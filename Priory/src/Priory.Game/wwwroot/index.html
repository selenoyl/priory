<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PRIORY</title>
  <style>
    :root {
      color-scheme: dark;
      --neon: #00ffd5;
      --neon-soft: color-mix(in srgb, var(--neon) 25%, transparent);
    }

    * { box-sizing: border-box; }

    body {
      font-family: system-ui, sans-serif;
      margin: 0;
      min-height: 100vh;
      background: #111;
      color: #eee;
      display: grid;
      place-items: center;
      overflow: hidden;
      font-size: clamp(14px, 1vw + 10px, 18px);
    }

    .wrap {
      width: min(96vw, 1120px);
      height: min(96vh, 900px);
      min-height: 0;
      padding: clamp(12px, 1.8vw, 24px);
      display: grid;
      grid-template-rows: auto minmax(0, 1fr) auto auto auto;
      gap: 12px;
      position: relative;
    }

    h1 {
      margin: 0;
      text-align: center;
      font-size: clamp(1.8rem, 2.2vw + 1rem, 3rem);
      letter-spacing: 0.12em;
      text-shadow: 0 0 12px color-mix(in srgb, var(--neon) 35%, transparent);
    }

    .title-row {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 14px;
    }


    .intro-splash {
      position: absolute;
      inset: 0;
      z-index: 30;
      background: radial-gradient(circle at 50% 35%, color-mix(in srgb, var(--neon) 12%, transparent), rgba(0,0,0,0.92));
      display: grid;
      place-items: center;
      transition: opacity 3000ms ease;
    }

    .intro-splash.fade-out { opacity: 0; pointer-events: none; }
    .intro-splash.hidden { display: none; }

    .splash-inner {
      text-align: center;
      display: grid;
      gap: 10px;
      justify-items: center;
    }

    .splash-motto {
      font-size: 0.72em;
      letter-spacing: 0.24em;
      text-transform: uppercase;
      color: #d8d2b9;
    }

    .crossmark {
      position: relative;
      width: 74px;
      height: 74px;
      filter: drop-shadow(0 0 8px color-mix(in srgb, var(--neon) 50%, transparent));
    }

    .crossmark .vert,
    .crossmark .horiz {
      position: absolute;
      background: var(--neon);
      border-radius: 2px;
    }

    .crossmark .vert { width: 14px; height: 68px; left: 30px; top: 3px; }
    .crossmark .horiz { width: 58px; height: 14px; left: 8px; top: 30px; }

    .log {
      width: 100%;
      min-height: 0;
      height: 100%;
      background: #1a1a1a;
      color: #ddd;
      border: 1px solid #333;
      padding: 12px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 6px;
      white-space: pre-wrap;
      scrollbar-gutter: stable;
      scrollbar-width: thin;
      scrollbar-color: #4e4e4e #1f1f1f;
    }

    .log::-webkit-scrollbar { width: 10px; }
    .log::-webkit-scrollbar-thumb { background: #4e4e4e; border-radius: 8px; }
    .log::-webkit-scrollbar-track { background: #1f1f1f; }

    .entry { line-height: 1.35; }
    .entry.system { font-style: italic; color: #b7c2d0; }
    .entry.system.tip { color: #9fc5a8; }
    .entry.system.error { color: #e7a1a1; }
    .entry.system.meta { color: #b6b0e6; }
    .entry.system.lore { font-weight: 700; color: #d8d2b5; }
    .entry.system.lp-lay { color: #dfb6ff; }
    .entry.system.lp-scholar { color: #9ec5ff; }
    .entry.system.lp-arms { color: #ffb2b2; }
    .entry.system.lp-merchant { color: #ffd58d; }
    .entry.system.lp-farmer { color: #b6e8ab; }

    input, select, button {
      padding: 8px;
      margin: 4px 0;
      background: #1e1e1e;
      color: #eee;
      border: 1px solid #444;
      min-height: 40px;
    }

    button {
      transition: border-color 140ms ease, box-shadow 140ms ease;
    }

    button:hover {
      border-color: var(--neon);
      box-shadow: 0 0 0 1px var(--neon-soft);
    }

    .row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
      position: relative;
    }

    #cmd { flex: 1; min-width: 220px; }

    .session-modal {
      position: absolute;
      inset: 0;
      display: grid;
      place-items: center;
      background: rgba(0, 0, 0, 0.72);
      z-index: 20;
    }

    .session-panel {
      width: min(92vw, 860px);
      border: 1px solid color-mix(in srgb, var(--neon) 35%, #444 65%);
      background: #161616;
      box-shadow: 0 0 0 1px color-mix(in srgb, var(--neon) 16%, transparent), 0 10px 28px rgba(0,0,0,0.35);
      padding: 16px;
      display: grid;
      gap: 10px;
    }


    .session-panel > button {
      justify-self: center;
      width: min(300px, 100%);
    }

    .session-panel h2 {
      margin: 0;
      text-align: center;
      font-size: clamp(1.1rem, 1vw + 0.8rem, 1.7rem);
      letter-spacing: 0.05em;
    }

    .session-subhead {
      color: #bdbdbd;
      font-size: 0.9em;
      text-align: center;
      justify-self: center;
    }

    .session-error {
      min-height: 1.2em;
      color: #e7a1a1;
      font-size: 0.92em;
    }

    .session-modal.hidden { display: none; }

    .session-grid {
      display: grid;
      grid-template-columns: minmax(320px, 520px) minmax(170px, 220px);
      gap: 16px;
      align-items: start;
      justify-content: center;
    }

    .session-flow {
      display: grid;
      gap: 12px;
      align-content: start;
    }

    .setup-step {
      display: grid;
      gap: 10px;
      padding: 10px;
      border: 1px solid color-mix(in srgb, var(--neon) 26%, #343434 74%);
      background: #141414;
    }

    .setup-step.hidden {
      display: none;
    }

    .session-actions {
      display: flex;
      gap: 8px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .session-actions button {
      min-width: 140px;
    }

    .field {
      display: grid;
      gap: 4px;
    }

    .field.hidden {
      display: none;
    }

    .field label {
      font-size: 0.82em;
      color: #bdbdbd;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .choice-group {
      border: 1px solid color-mix(in srgb, var(--neon) 20%, #373737 80%);
      padding: 8px;
      display: grid;
      gap: 6px;
      background: #191919;
    }

    .tick-option {
      display: flex;
      align-items: center;
      gap: 8px;
      color: #d4d4d4;
      font-size: 0.94em;
      min-height: 32px;
    }

    .tick-option input {
      width: 18px;
      height: 18px;
      margin: 0;
      accent-color: var(--neon);
    }

    .field.centered {
      grid-column: 1 / -1;
      justify-items: center;
      text-align: center;
    }

    #neonColor {
      min-width: min(100%, 360px);
      text-align: center;
    }

    .password-hint {
      font-size: 0.85em;
      color: #c7be98;
      min-height: 1.2em;
    }

    .party-code-field.hidden {
      display: none;
    }


    .startup-sprite-pane {
      grid-column: 2 / 3;
      grid-row: 1;
      border: 1px solid #353535;
      background: #161616;
      padding: 8px;
      display: grid;
      gap: 8px;
      align-content: start;
      justify-items: center;
    }

    .startup-sprite-stage {
      width: 140px;
      height: 180px;
      border: 1px solid #2f2f2f;
      position: relative;
      background: radial-gradient(circle at 50% 22%, color-mix(in srgb, var(--neon) 15%, transparent), transparent 55%), #151515;
      overflow: hidden;
    }

    .startup-sprite-stage .poly.head { top: 22px; width: 52px; height: 52px; }
    .startup-sprite-stage .poly.torso { top: 66px; width: 102px; height: 118px; }
    .startup-sprite-stage .poly.cloak { top: 72px; width: 124px; height: 136px; }

    .party-code-field { justify-items: center; text-align: center; }

    #partyCode {
      width: 10ch;
      min-width: 10ch;
      text-align: center;
      letter-spacing: 0.08em;
    }

    .timed-panel {
      border: 1px solid color-mix(in srgb, var(--neon) 34%, #5a4a2f 66%);
      background: #1f1a12;
      padding: 10px;
      display: grid;
      gap: 8px;
      opacity: 1;
      transition: opacity 180ms ease;
    }

    .timed-panel.fading { opacity: 0; }
    .timed-panel.hidden { display: none; }
    .timed-header { display:flex; justify-content: space-between; gap: 8px; color: #eddab0; }
    .timed-options { display:flex; flex-wrap: wrap; gap: 8px; }

    .quick-panel {
      border: 1px solid color-mix(in srgb, var(--neon) 34%, #5a4a2f 66%);
      background: #1f1a12;
      padding: 8px;
      display: none;
      gap: 8px;
    }

    .quick-panel.show { display: grid; }
    .quick-buttons { display: flex; flex-wrap: wrap; gap: 8px; }

    .menu-popover,
    .options-popover {
      position: absolute;
      right: 0;
      top: calc(100% + 8px);
      border: 1px solid color-mix(in srgb, var(--neon) 22%, #3f3f3f 78%);
      background: #151515;
      padding: 8px;
      min-width: 230px;
      display: none;
      z-index: 12;
      box-shadow: 0 8px 24px rgba(0,0,0,0.35);
    }

    .menu-popover.show,
    .options-popover.show {
      display: grid;
      gap: 6px;
    }

    .options-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: #bfbfbf;
      font-size: 0.82em;
      letter-spacing: 0.03em;
      text-transform: uppercase;
    }

    .close-options {
      min-height: 26px;
      width: 26px;
      margin: 0;
      line-height: 1;
      padding: 0;
      font-weight: 700;
    }

    .options-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      font-size: 0.92em;
      color: #c7c7c7;
    }

    .inventory-modal {
      position: absolute;
      inset: 0;
      display: none;
      place-items: center;
      background: rgba(0, 0, 0, 0.72);
      z-index: 18;
      padding: 20px;
    }

    .inventory-modal.show { display: grid; }

    .inventory-shell {
      width: min(94vw, 920px);
      min-height: min(72vh, 620px);
      border: 1px solid var(--neon);
      box-shadow: 0 0 30px color-mix(in srgb, var(--neon) 30%, transparent);
      background: #121212;
      display: grid;
      grid-template-columns: minmax(220px, 320px) 1fr;
    }

    .sprite-pane {
      border-right: 1px solid #303030;
      padding: 14px;
      display: grid;
      grid-template-rows: auto 1fr auto;
      gap: 12px;
      background: linear-gradient(180deg, #151515 0%, #111 100%);
    }

    .sprite-stage {
      border: 1px solid #2f2f2f;
      background: radial-gradient(circle at 50% 15%, color-mix(in srgb, var(--neon) 14%, transparent), transparent 55%), #151515;
      position: relative;
      min-height: 340px;
      overflow: hidden;
    }

    .poly {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      filter: drop-shadow(0 0 9px color-mix(in srgb, var(--neon) 50%, transparent));
    }

    .poly.head {
      top: 58px;
      width: 84px;
      height: 84px;
      background: color-mix(in srgb, var(--neon) 80%, #fff 20%);
      clip-path: polygon(50% 0%, 88% 18%, 100% 56%, 70% 100%, 26% 100%, 0% 56%, 12% 18%);
    }

    .poly.torso {
      top: 132px;
      width: 170px;
      height: 210px;
      background: color-mix(in srgb, var(--neon) 68%, #000 32%);
      clip-path: polygon(50% 0%, 98% 24%, 88% 88%, 50% 100%, 12% 88%, 2% 24%);
    }

    .poly.cloak {
      top: 146px;
      width: 220px;
      height: 238px;
      background: #131313;
      border: 1px solid color-mix(in srgb, var(--neon) 45%, transparent);
      clip-path: polygon(50% 0%, 90% 12%, 100% 100%, 0% 100%, 10% 12%);
    }

    .cloak-scholar .poly.cloak { background: linear-gradient(180deg, #1b1d27, #0f1118); }
    .cloak-merchant .poly.cloak { background: linear-gradient(180deg, #201f17, #12110d); }
    .cloak-arms .poly.cloak { background: linear-gradient(180deg, #1d1d1d, #0f0f0f); }
    .cloak-farmer .poly.cloak { background: linear-gradient(180deg, #1b2017, #10140d); }
    .cloak-lay .poly.cloak { background: linear-gradient(180deg, #211921, #131013); }

    .inventory-pane {
      padding: 14px;
      display: grid;
      grid-template-rows: auto auto 1fr auto;
      gap: 10px;
      min-height: 0;
    }

    .inventory-list {
      border: 1px solid #323232;
      background: #181818;
      padding: 10px;
      overflow-y: auto;
      min-height: 220px;
    }

    .inventory-item {
      border-left: 3px solid var(--neon);
      padding: 6px 8px;
      margin-bottom: 8px;
      background: color-mix(in srgb, var(--neon) 10%, #1c1c1c 90%);
      color: #e4e4e4;
    }

    .inventory-controls {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    .virtue-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(160px, 1fr));
      gap: 8px;
      margin-top: 2px;
      font-style: normal;
    }

    .virtue-card {
      background: #171717;
      border: 1px solid #303030;
      padding: 6px;
      display: grid;
      gap: 4px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size: 0.83em;
    }

    .virtue-bar {
      letter-spacing: 0;
      white-space: pre;
    }

    .status {
      display: flex;
      justify-content: space-between;
      color: #bdbdbd;
      font-size: 0.9em;
      margin-top: auto;
    }
  </style>
</head>
<body>
<div class="wrap">
  <div id="introSplash" class="intro-splash">
    <div class="splash-inner">
      <div class="crossmark" aria-hidden="true" style="transform: translateY(-20px) scale(2.25); margin: 0 0 18px;">
        <div class="vert"></div><div class="horiz"></div>
      </div>
      <div class="splash-motto">LAUDARE, BENEDICERE, PRAEDICARE.</div>
    </div>
  </div>

  <div id="sessionModal" class="session-modal">
    <div class="session-panel">
      <h2>Go it alone — or gather your order.</h2>
      <div class="session-subhead">Use login/register for account play, or guest for quick entry.</div>
      <div class="session-grid">
        <div class="session-flow">
          <div id="setupStep1" class="setup-step">
            <div class="field">
              <label>Session Type</label>
              <div class="choice-group" id="authModeGroup">
                <label class="tick-option"><input type="radio" name="authMode" value="guest" checked> Guest</label>
                <label class="tick-option"><input type="radio" name="authMode" value="login"> Login</label>
                <label class="tick-option"><input type="radio" name="authMode" value="register"> Register</label>
              </div>
            </div>

            <div class="field">
              <label>World Mode</label>
              <div class="choice-group" id="worldModeGroup">
                <label class="tick-option"><input type="radio" name="mode" value="solo" checked> Solo</label>
                <label class="tick-option"><input type="radio" name="mode" value="create"> Create Party</label>
                <label class="tick-option"><input type="radio" name="mode" value="join"> Join Party</label>
              </div>
            </div>

            <div class="session-actions">
              <button type="button" onclick="goToSessionDetails()">Next</button>
            </div>
          </div>

          <div id="setupStep2" class="setup-step hidden">
            <div class="field">
              <label for="name">Character Name</label>
              <input id="name" placeholder="Character name" />
            </div>

            <div id="passwordField" class="field hidden">
              <label for="password">Password</label>
              <input id="password" type="password" placeholder="Password" />
              <div id="passwordHint" class="password-hint"></div>
            </div>

            <div class="field">
              <label>Gender</label>
              <div class="choice-group" id="sexGroup">
                <label class="tick-option"><input type="radio" name="sex" value="male" checked> Male</label>
                <label class="tick-option"><input type="radio" name="sex" value="female"> Female</label>
              </div>
            </div>

            <div id="partyCodeField" class="field party-code-field hidden">
              <label for="partyCode">Party Code</label>
              <input id="partyCode" placeholder="000-000" />
            </div>

            <div class="field centered">
              <label for="neonColor">Character Color</label>
              <select id="neonColor"></select>
            </div>

            <div class="session-actions">
              <button type="button" onclick="backToSessionChoices()">Back</button>
              <button type="button" onclick="startSession()">Begin Session</button>
            </div>
          </div>
        </div>

        <div id="startupSpritePane" class="startup-sprite-pane cloak-lay">

          <div class="startup-sprite-stage">
            <div class="poly cloak"></div>
            <div class="poly torso"></div>
            <div class="poly head"></div>
          </div>
        </div>
      </div>
      <div id="sessionError" class="session-error" role="alert" aria-live="assertive"></div>
    </div>
  </div>

  <div id="inventoryModal" class="inventory-modal" aria-modal="true" role="dialog" aria-label="Inventory">
    <div class="inventory-shell">
      <div id="spritePane" class="sprite-pane cloak-lay">
        <div style="color:#bdbdbd;font-size:0.9em">Pilgrim Profile</div>
        <div class="sprite-stage">
          <div class="poly cloak"></div>
          <div class="poly torso"></div>
          <div class="poly head"></div>
        </div>
        <div id="spriteClassLabel" style="font-size:0.9em;color:#bdbdbd">Life Path: Unchosen</div>
      </div>
      <div class="inventory-pane">
        <h3 style="margin:0;color:var(--neon)">Inventory</h3>
        <div id="inventoryMeta" style="font-size:0.92em;color:#c9c9c9">Loading...</div>
        <div id="inventoryList" class="inventory-list"></div>
        <div class="inventory-controls">
          <button onclick="closeInventory()">Close</button>
        </div>
      </div>
    </div>
  </div>

  <div class="title-row">
    <h1>PRIORY</h1>
  </div>

  <div id="log" class="log" aria-live="polite"></div>

  <div id="timedPanel" class="timed-panel hidden">
    <div class="timed-header">
      <strong id="timedPrompt"></strong>
      <span id="timedTimer">00</span>
    </div>
    <div id="timedOptions" class="timed-options"></div>
  </div>

  <div class="row" id="commandRow">
    <input id="cmd" placeholder="Type command..." autocomplete="off" />
    <button id="sendBtn" onclick="sendCommand()">Send</button>
    <button id="inventoryBtn" onclick="openInventory()">Inventory</button>
    <button id="menuBtn" onclick="toggleMenuPopover()">Menu</button>

    <div id="menuPopover" class="menu-popover">
      <button onclick="toggleOptionsPopover()">Options</button>
      <button onclick="saveAndQuit()">Save and Quit</button>
      <button onclick="closeMenuPopover()">Close Menu</button>
    </div>

    <div id="optionsPopover" class="options-popover">
      <div class="options-head">
        <span>Options</span>
        <button class="close-options" onclick="closeOptionsPopover()">×</button>
      </div>
      <label class="options-row">
        Show Quick Access menu
        <input id="showQuickAccessToggle" type="checkbox" />
      </label>
    </div>
  </div>

  <div id="quickPanel" class="quick-panel" aria-label="Quick actions">
    <div style="color:#eddab0;font-size:0.9em">Quick actions</div>
    <div class="quick-buttons">
      <button onclick="quickAction('look')">Look</button>
      <button onclick="quickAction('inventory')">Inventory</button>
      <button onclick="quickAction('status')">Status</button>
      <button onclick="quickAction('virtues')">Virtues</button>
      <button onclick="quickAction('quests')">Quests</button>
      <button onclick="quickAction('party')">Party</button>
      <button onclick="quickAction('help')">Help</button>
    </div>
  </div>

  <div class="status">
    <div id="currentUser">Current User: -</div>
    <div id="currentPartyCode">Party Code: -</div>
  </div>
</div>

<script>
const NEON_COLORS = [
  '#00f5ff', '#00ff9f', '#39ff14', '#ff00f7', '#ff6b00', '#ffd400',
  '#9d00ff', '#00b3ff', '#ff2e63', '#00ffa2', '#7df9ff', '#f72585'
];

let sessionId = null;
let activeTimedPrompt = null;
let timedInterval = null;
let shouldStickToBottom = true;
let userNeonColor = NEON_COLORS[Math.floor(Math.random() * NEON_COLORS.length)];
let showQuickAccess = false;

function selectedRadio(name) {
  return document.querySelector(`input[name="${name}"]:checked`)?.value || '';
}

function initNeonPicker() {
  const picker = document.getElementById('neonColor');
  picker.innerHTML = '';

  const randomOpt = document.createElement('option');
  randomOpt.value = 'random';
  randomOpt.textContent = 'Random neon';
  randomOpt.style.color = '#f0f0f0';
  picker.appendChild(randomOpt);

  NEON_COLORS.forEach((hex, idx) => {
    const opt = document.createElement('option');
    opt.value = hex;
    opt.textContent = `Color ${idx + 1} (${hex})`;
    opt.style.color = hex;
    opt.style.fontWeight = '700';
    picker.appendChild(opt);
  });

  picker.value = 'random';
}

function applyNeon(color) {
  userNeonColor = color;
  document.documentElement.style.setProperty('--neon', color);
}

function resolveNeonSelection() {
  const selected = document.getElementById('neonColor').value;
  if (selected === 'random') {
    return NEON_COLORS[Math.floor(Math.random() * NEON_COLORS.length)];
  }
  return selected;
}

function classifyLine(line) {
  if (!line) return 'system';
  if (line.startsWith('ERROR:')) return 'system error';
  if (line.startsWith('Tip:') || line.startsWith('Hint:')) return 'system tip';
  if (line.startsWith('SAVE CODE:') || line.startsWith('Version:') || line.startsWith('From here you can travel') || line.startsWith('Travel options:')) return 'system meta';
  if (line.startsWith('England, Anno Domini') || line.startsWith('You arrive in Blackpine') || line.startsWith('Rebellion scars') || line.startsWith('Saint Catherine Priory endures') || line.startsWith('Here, mercy must be practical')) return 'system lore';
  if (line.includes('Lay Aspirant')) return 'system lp-lay';
  if (line.includes("Scholar's Son")) return 'system lp-scholar';
  if (line.includes('Former Man-at-Arms')) return 'system lp-arms';
  if (line.includes("Merchant's Apprentice")) return 'system lp-merchant';
  if (line.includes("Farmer's Son")) return 'system lp-farmer';
  if (line.startsWith('Go where?') || line.startsWith('Be specific.') || line.startsWith('Start a session first.') || line.startsWith('Choose a number.')) return 'system';
  return 'narrative';
}

function appendVirtueGrid(line) {
  const el = document.createElement('div');
  el.className = 'entry system';

  const [title, ...rows] = line.split('\n').filter(x => x.trim().length > 0);
  const titleEl = document.createElement('div');
  titleEl.textContent = title || 'Virtues';
  el.appendChild(titleEl);

  const grid = document.createElement('div');
  grid.className = 'virtue-grid';

  for (const row of rows) {
    const match = row.match(/^(\S+)\s+([A-Za-z]+)\s+\[([^\]]+)\]\s+([+\-0-9]+)/);
    const card = document.createElement('div');
    card.className = 'virtue-card';

    const head = document.createElement('div');
    const bar = document.createElement('div');
    bar.className = 'virtue-bar';

    if (match) {
      head.textContent = `${match[1]} ${match[2]} ${match[4]}`;
      bar.textContent = `[${match[3]}]`;
    } else {
      head.textContent = row;
    }

    card.appendChild(head);
    card.appendChild(bar);
    grid.appendChild(card);
  }

  el.appendChild(grid);
  return el;
}

function append(lines) {
  const log = document.getElementById('log');
  const wasNearBottom = (log.scrollHeight - log.scrollTop - log.clientHeight) < 24;

  for (const rawLine of lines || []) {
    const subLines = String(rawLine).split('\n').filter(x => x.length > 0);
    if (subLines.length === 0) continue;

    for (const line of subLines) {
      if (line.startsWith('Virtues')) {
        log.appendChild(appendVirtueGrid(rawLine));
        break;
      }

      if (/^Scrollable line\s+\d+$/i.test(line.trim())) {
        continue;
      }

      const el = document.createElement('div');
      el.className = `entry ${classifyLine(line)}`;
      el.textContent = line;
      log.appendChild(el);
    }
  }

  if (shouldStickToBottom || wasNearBottom) {
    requestAnimationFrame(() => {
      log.scrollTop = log.scrollHeight;
    });
  }
}

function focusCommandBox() {
  const cmd = document.getElementById('cmd');
  cmd.focus();
  cmd.setSelectionRange(cmd.value.length, cmd.value.length);
}

function setSessionDetails(playerName, partyCode) {
  document.getElementById('currentUser').textContent = `Current User: ${playerName || '-'}`;
  document.getElementById('currentPartyCode').textContent = `Party Code: ${partyCode || '-'}`;
}

function setInputEnabled(enabled) {
  document.getElementById('cmd').disabled = !enabled;
  document.getElementById('sendBtn').disabled = !enabled;
  document.getElementById('inventoryBtn').disabled = !enabled;
}

function updateQuickPanelVisibility() {
  const quickPanel = document.getElementById('quickPanel');
  quickPanel.classList.toggle('show', showQuickAccess);
}

function closeOptionsPopover() {
  document.getElementById('optionsPopover').classList.remove('show');
}

function closeMenuPopover() {
  document.getElementById('menuPopover').classList.remove('show');
  closeOptionsPopover();
}

function toggleMenuPopover() {
  const menu = document.getElementById('menuPopover');
  const shouldShow = !menu.classList.contains('show');
  closeMenuPopover();
  if (shouldShow) menu.classList.add('show');
}

function toggleOptionsPopover() {
  const options = document.getElementById('optionsPopover');
  options.classList.toggle('show');
}

function updatePartyCodeVisibility() {
  const show = selectedRadio('mode') === 'join';
  document.getElementById('partyCodeField').classList.toggle('hidden', !show);
}

function updatePasswordVisibility() {
  const authMode = selectedRadio('authMode');
  const show = authMode === 'login' || authMode === 'register';
  document.getElementById('passwordField').classList.toggle('hidden', !show);
}

function updatePasswordHint() {
  const authMode = selectedRadio('authMode');
  const hint = document.getElementById('passwordHint');
  hint.textContent = authMode === 'register'
    ? 'Friendly reminder: passwords must be at least 8 characters.'
    : '';
}

function syncSessionDetailFields() {
  updatePartyCodeVisibility();
  updatePasswordVisibility();
  updatePasswordHint();
}

function goToSessionDetails() {
  document.getElementById('sessionError').textContent = '';
  document.getElementById('setupStep1').classList.add('hidden');
  document.getElementById('setupStep2').classList.remove('hidden');
  syncSessionDetailFields();
  document.getElementById('name').focus();
}

function backToSessionChoices() {
  document.getElementById('sessionError').textContent = '';
  document.getElementById('setupStep2').classList.add('hidden');
  document.getElementById('setupStep1').classList.remove('hidden');
}

function clearTimedPrompt({ fade = false } = {}) {
  activeTimedPrompt = null;
  if (timedInterval) {
    clearInterval(timedInterval);
    timedInterval = null;
  }

  const panel = document.getElementById('timedPanel');
  if (fade) {
    panel.classList.add('fading');
    setTimeout(() => {
      panel.classList.add('hidden');
      panel.classList.remove('fading');
    }, 180);
  } else {
    panel.classList.add('hidden');
    panel.classList.remove('fading');
  }

  setInputEnabled(true);
}

async function resolveTimed(choice, auto = false) {
  if (!sessionId || !activeTimedPrompt) return;
  clearTimedPrompt({ fade: auto });
  if (auto) append(["Tip: time expired, so a default response was chosen."]);

  const timedRes = await fetch(`/api/sessions/${sessionId}/timed`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ choice })
  });
  const timedData = await timedRes.json();
  if (!timedRes.ok) { append([`ERROR: ${timedData.error || 'timed command failed'}`]); return; }

  append(timedData.lines || []);
  if (timedData.timedPrompt) startTimedPrompt(timedData.timedPrompt);
  else focusCommandBox();
}

function startTimedPrompt(promptData) {
  activeTimedPrompt = promptData;
  setInputEnabled(false);

  const panel = document.getElementById('timedPanel');
  panel.classList.remove('hidden');
  panel.classList.remove('fading');

  document.getElementById('timedPrompt').textContent = promptData.prompt;
  const options = document.getElementById('timedOptions');
  options.innerHTML = '';

  (promptData.options || []).forEach((opt, idx) => {
    const btn = document.createElement('button');
    btn.textContent = `${idx + 1}) ${opt}`;
    btn.onclick = () => resolveTimed(idx + 1, false);
    options.appendChild(btn);
  });

  const deadline = new Date(promptData.deadline).getTime();
  const timerEl = document.getElementById('timedTimer');
  const tick = () => {
    const remain = Math.max(0, Math.ceil((deadline - Date.now()) / 1000));
    timerEl.textContent = `${remain}s`;
    if (remain <= 0) resolveTimed(0, true);
  };
  tick();
  timedInterval = setInterval(tick, 250);
}

async function startSession() {
  const sessionErrorEl = document.getElementById('sessionError');
  sessionErrorEl.textContent = '';
  applyNeon(resolveNeonSelection());

  const mode = selectedRadio('mode');
  const authMode = selectedRadio('authMode');
  const password = document.getElementById('password').value.trim();
  const playerName = document.getElementById('name').value.trim();
  const partyCode = document.getElementById('partyCode').value.trim();
  const sex = selectedRadio('sex') || 'male';
  const username = authMode === 'guest' ? null : playerName;

  let res;
  try {
    res = await fetch('/api/sessions', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ mode, playerName, partyCode, authMode, username, password, sex })
    });
  } catch {
    sessionErrorEl.textContent = 'Could not reach server. Please try again.';
    return;
  }

  const data = await res.json();
  if (!res.ok) {
    const message = data.error || 'session start failed';
    const modalOpen = !document.getElementById('sessionModal').classList.contains('hidden');
    if (modalOpen) {
      sessionErrorEl.textContent = message;
    } else {
      append([`ERROR: ${message}`]);
    }
    return;
  }

  sessionId = data.sessionId;
  append(data.bootstrapLines);

  const activePartyCode = data.partyCode || data.activePartyCode || (mode === 'join' ? partyCode : '');
  setSessionDetails(data.username || playerName || 'Guest', activePartyCode);

  document.getElementById('sessionModal').classList.add('hidden');
  sessionErrorEl.textContent = '';
  focusCommandBox();
}

function quickAction(command) {
  const cmd = document.getElementById('cmd');
  cmd.value = command;
  sendCommand();
}

function cloakClassForLifePath(lifePath) {
  const name = (lifePath || '').toLowerCase();
  if (name.includes('scholar')) return 'cloak-scholar';
  if (name.includes('merchant')) return 'cloak-merchant';
  if (name.includes('arms')) return 'cloak-arms';
  if (name.includes('farmer')) return 'cloak-farmer';
  return 'cloak-lay';
}

function renderInventory(overview) {
  const list = document.getElementById('inventoryList');
  const meta = document.getElementById('inventoryMeta');
  const classLabel = document.getElementById('spriteClassLabel');
  const spritePane = document.getElementById('spritePane');

  spritePane.className = `sprite-pane ${cloakClassForLifePath(overview.lifePath)}`;
  classLabel.textContent = `Life Path: ${overview.lifePath || 'Unchosen'}`;
  meta.textContent = `${overview.playerName || 'Pilgrim'} • Coin: ${overview.coin ?? 0}`;

  list.innerHTML = '';
  if (!overview.inventory || overview.inventory.length === 0) {
    list.innerHTML = '<div class="inventory-item">(empty)</div>';
  } else {
    overview.inventory.forEach((item, idx) => {
      const el = document.createElement('div');
      el.className = 'inventory-item';
      el.textContent = `${idx + 1}. ${item}`;
      list.appendChild(el);
    });
  }
}

async function openInventory() {
  if (!sessionId) {
    append(['Start a session first.']);
    return;
  }

  const modal = document.getElementById('inventoryModal');
  modal.classList.add('show');

  try {
    const res = await fetch(`/api/sessions/${sessionId}/overview`);
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || 'overview unavailable');
    renderInventory({
      playerName: data.playerName,
      lifePath: data.lifePath,
      inventory: data.inventory || [],
      coin: data.coin ?? 0
    });
  } catch {
    renderInventory({
      playerName: 'Pilgrim',
      lifePath: 'Lay Aspirant',
      inventory: ['Psalter (worn)', 'Small wooden rosary', 'Plain tunic'],
      coin: 0
    });
  }
}

function closeInventory() {
  document.getElementById('inventoryModal').classList.remove('show');
}


async function endSessionAndReturnToStart() {
  if (sessionId) {
    try {
      await fetch(`/api/sessions/${sessionId}`, { method: 'DELETE' });
    } catch {}
  }

  sessionId = null;
  activeTimedPrompt = null;
  if (timedInterval) {
    clearInterval(timedInterval);
    timedInterval = null;
  }

  const panel = document.getElementById('timedPanel');
  panel.classList.add('hidden');
  panel.classList.remove('fading');

  setInputEnabled(false);
  document.getElementById('cmd').value = '';
  document.getElementById('sessionError').textContent = '';
  document.getElementById('setupStep2').classList.add('hidden');
  document.getElementById('setupStep1').classList.remove('hidden');
  document.getElementById('sessionModal').classList.remove('hidden');
  setSessionDetails('', '');
}

async function saveAndQuit() {
  closeMenuPopover();
  if (sessionId) {
    try {
      const res = await fetch(`/api/sessions/${sessionId}/command`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ input: 'save' })
      });
      const data = await res.json();
      if (res.ok) append(data.lines || []);
    } catch {
      append(['ERROR: Could not save before quitting.']);
    }
  }

  await endSessionAndReturnToStart();
}

async function sendCommand() {
  if (!sessionId) { append(['Start a session first.']); return; }
  if (activeTimedPrompt) { append(['Timed decision pending. Choose one option below.']); return; }

  const input = document.getElementById('cmd').value;
  if (!input.trim()) { return; }
  document.getElementById('cmd').value = '';

  const res = await fetch(`/api/sessions/${sessionId}/command`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ input })
  });

  const data = await res.json();
  if (!res.ok) { append([`ERROR: ${data.error || 'command failed'}`]); return; }
  append(data.lines);

  if (data.timedPrompt) {
    startTimedPrompt(data.timedPrompt);
    return;
  }

  if (data.quitToMenu) {
    await endSessionAndReturnToStart();
    return;
  }

  focusCommandBox();
}

const cmdInput = document.getElementById('cmd');
cmdInput.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') {
    e.preventDefault();
    sendCommand();
  }
});

window.addEventListener('keydown', (e) => {
  if (e.defaultPrevented || e.ctrlKey || e.metaKey || e.altKey) return;

  const active = document.activeElement;
  if (active && (active.tagName === 'INPUT' || active.tagName === 'TEXTAREA' || active.tagName === 'SELECT') && active.id !== 'cmd') {
    return;
  }

  if (e.key.length === 1 || e.key === 'Backspace' || e.key === 'Delete') {
    focusCommandBox();
  }

  if (e.key === 'Escape') {
    closeMenuPopover();
    closeInventory();
  }
});

window.addEventListener('click', (e) => {
  const row = document.getElementById('commandRow');
  if (!row.contains(e.target)) {
    closeMenuPopover();
  }
});

const logEl = document.getElementById('log');
logEl.addEventListener('scroll', () => {
  const remaining = logEl.scrollHeight - logEl.scrollTop - logEl.clientHeight;
  shouldStickToBottom = remaining < 20;
});

window.addEventListener('resize', () => {
  if (shouldStickToBottom) {
    requestAnimationFrame(() => {
      logEl.scrollTop = logEl.scrollHeight;
    });
  }
});


function playIntroSplash() {
  const splash = document.getElementById('introSplash');
  if (!splash) return;

  setTimeout(() => {
    splash.classList.add('fade-out');
    setTimeout(() => splash.classList.add('hidden'), 3050);
  }, 900);
}

const quickAccessToggle = document.getElementById('showQuickAccessToggle');
quickAccessToggle.checked = false;
quickAccessToggle.addEventListener('change', () => {
  showQuickAccess = quickAccessToggle.checked;
  updateQuickPanelVisibility();
});

document.querySelectorAll('input[name="mode"]').forEach(el => el.addEventListener('change', updatePartyCodeVisibility));
document.querySelectorAll('input[name="authMode"]').forEach(el => el.addEventListener('change', syncSessionDetailFields));
document.getElementById('neonColor').addEventListener('change', () => applyNeon(resolveNeonSelection()));

initNeonPicker();
applyNeon(userNeonColor);
updateQuickPanelVisibility();
syncSessionDetailFields();
playIntroSplash();
setSessionDetails('', '');
setInputEnabled(false);
</script>
</body>
</html>
